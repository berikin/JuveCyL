var map_origin=new Array(2);var map_destiny=new Array(2);var tits=new Array();var ids=new Array();var total_distance=0;var map;var aux;function traceRoute(){if($("#mapinstructions").length){$("#mapinstructions").remove()}$('<div id="mapinstructions"></div>').html("").appendTo("#generalmap");$("#mapinstructions").append('<img id="closeinstructions" src="img/cerrar.png" class="fade" alt="cerrar"></img>');$("#closeinstructions").bind({click:function(a){map_origin=new Array(2);map_destiny=new Array(2);total_distance=0;$("#mapinstructions").fadeOut(800,function(){$("#mapinstructions").remove()})}});$("#mapinstructions").append('<h2 id="totalkm"></h2>');$("#mapinstructions").append('<div style="height:80%; overflow:scroll; " id="instructions"></div>');window.map.travelRoute({origin:window.map_origin,destination:window.map_destiny,travelMode:"driving",step:function(b){var a=b.distance.value;window.total_distance=window.total_distance+b.distance.value;if(a>1000){a=a/1000;a=a.toLocaleString()+" Kilómetros"}else{a=a.toLocaleString()+" Metros"}$("#instructions").append("<li>"+b.instructions+" - "+a+"</li>");$("#instructions li:eq("+b.step_number+")").delay(450*b.step_number).fadeIn(200,function(){window.map.drawPolyline({path:b.path,strokeColor:"#131540",strokeOpacity:0.6,strokeWeight:6});if(window.total_distance>1000){window.total_distance=window.total_distance/1000;window.total_distance=window.total_distance.toLocaleString()+" Kilómetros"}$("#totalkm").html("Distancia total: "+window.total_distance);$("#mapinstructions").fadeIn(800)})}});map_origin=new Array(2);map_destiny=new Array(2);total_distance=0}function loadMap(){$("#map").click(function(a){a.stopPropagation();$('<span class="closemapspan"></span>').html('<img id="closemap" src="img/cerrar.png" class="fade" alt="cerrar"></img>').appendTo("body");$('<div id="generalmap"></div>').html("").appendTo("body");$("#generalmap").bind({click:function(b){b.stopPropagation()}});$("#generalmap").css("height","80%");$("#generalmap").css("width","80%");$("#generalmap").css("position","absolute");$("#generalmap").fadeIn(800);$.when(window.map=new GMaps({div:"#generalmap",lat:41.652393,lng:-4.762573,zoom:8})).done(function(){$("#closemap").bind({click:function(b){b.preventDefault();$(".closemapspan").fadeOut(800,function(){$(".closemapspan").remove()});$("#gmaps_context_menu").remove();$("#generalmap").fadeOut(800,function(){$("#generalmap").remove()})},mouseenter:function(){$(this).fadeOut("fast");$(this).attr("src","img/cerrarhover.png");$(this).fadeIn("fast")},mouseleave:function(){$(this).fadeOut("fast");$(this).attr("src","img/cerrar.png");$(this).fadeIn("fast")}});$("#closemap").bind("click",function(b){b.preventDefault();$(".closemapspan").fadeOut(800,function(){$(".closemapspan").remove()});$("#gmaps_context_menu").remove();$("#generalmap").fadeOut(800,function(){$("#generalmap").remove()})});loadMarks()})})}function addMark(){if(aux<ids.length){var a=$.ajax({type:"GET",url:"db/locs.xml",dataType:"xml",success:function(b){$(b).find("loc").each(function(){if($(this).find("id").text()==ids[aux]){window.map.addMarker({lat:$(this).find("lat").text(),lng:$(this).find("long").text(),title:tits[aux],icon:"img/casa_mapa.png",infoWindow:{content:"<p>"+tits[aux]+"</p> <p>"+$(this).find("name").text()+"</p>"}});return false}})},error:function(b,d,c){console.log(c.toString())}});a.done(function(){aux++;addMark()})}}function loadMarks(){var a=$.ajax({type:"GET",url:"db/inns.xml",dataType:"xml",success:function(b){$(b).find("element").each(function(){ids.push($(this).find('attribute[name="Identificador"]').text());tits.push($(this).find('attribute[name="Titulo_es"]').find("string").text())})}});a.done(function(){aux=0;addMark();loadResult()})}function loadResult(){window.map.setContextMenu({control:"map",options:[{title:"Ruta desde aquí",name:"route_origin",action:function(a){window.map_origin[0]=a.latLng.lat();window.map_origin[1]=a.latLng.lng();if(window.map_origin[0]!==undefined&&window.map_destiny[0]!==undefined){traceRoute()}}},{title:"Ruta hasta aquí",name:"route_destiny",action:function(a){window.map_destiny[0]=a.latLng.lat();window.map_destiny[1]=a.latLng.lng();if(window.map_origin[0]!==undefined&&window.map_destiny[0]!==undefined){traceRoute()}}}]});$("#gmaps_context_menu").bind("click",function(a){a.stopPropagation()})}$(document).ready(function(){$(document).bind("contextmenu",function(a){});$("body").click(function(){if($("#generalmap").length){$(".closemapspan").fadeOut(800,function(){$(".closemapspan").remove()});$("#gmaps_context_menu").remove();$("#generalmap").fadeOut(800,function(){$("#generalmap").remove()})}});loadMap()});